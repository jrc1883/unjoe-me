---
import { getCollection } from 'astro:content';
import BaseHead from '../../../components/BaseHead.astro';
import Header from '../../../components/Header.astro';
import Footer from '../../../components/Footer.astro';
import { SITE_TITLE } from '../../../consts';
import { getReadingTimeFromEntry, formatReadingTime } from '../../../utils/reading-time';

export async function getStaticPaths() {
	const posts = await getCollection('blog');

	// Extract unique tags
	const uniqueTags = [...new Set(
		posts.flatMap(post => post.data.tags || [])
	)];

	return uniqueTags.map(tag => ({
		params: { tag },
		props: {
			tag,
			posts: posts
				.filter(post => post.data.tags?.includes(tag))
				.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()),
		},
	}));
}

const { tag, posts } = Astro.props;

function formatDate(date: Date) {
	return date.toLocaleDateString('en-US', {
		year: 'numeric',
		month: 'short',
		day: 'numeric'
	});
}

// Capitalize first letter of tag for display
const tagDisplay = tag.split('-').map((word: string) =>
	word.charAt(0).toUpperCase() + word.slice(1)
).join(' ');
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead
			title={`${tagDisplay} | ${SITE_TITLE}`}
			description={`Articles about ${tagDisplay.toLowerCase()} - ${posts.length} ${posts.length === 1 ? 'post' : 'posts'}`}
		/>
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
	</head>
	<body>
		<Header />
		<main>
			<div class="container">
				<!-- Breadcrumb -->
				<nav class="breadcrumb">
					<a href="/blog/">Writings</a>
					<span class="separator">/</span>
					<span class="current">{tagDisplay}</span>
				</nav>

				<!-- Page Header -->
				<header class="page-header">
					<div class="tag-badge">{tagDisplay}</div>
					<h1>{posts.length} {posts.length === 1 ? 'Writing' : 'Writings'}</h1>
					<p class="subtitle">
						Explore articles about {tagDisplay.toLowerCase()}
					</p>
				</header>

				<!-- Posts List -->
				<section class="posts-section">
					<div class="posts-list">
						{posts.map((post, index) => (
							<a href={`/blog/${post.id}/`} class="post-item">
								<span class="post-number">{String(index + 1).padStart(2, '0')}</span>
								<div class="post-content">
									<h4>{post.data.title}</h4>
									<p>{post.data.description}</p>
									<div class="post-meta">
										<time datetime={post.data.pubDate.toISOString()}>
											{formatDate(post.data.pubDate)}
										</time>
										<span class="meta-separator">•</span>
										<span class="reading-time">{formatReadingTime(getReadingTimeFromEntry(post))}</span>
									</div>
								</div>
								<span class="post-arrow">
									<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<path d="M5 12h14M12 5l7 7-7 7"/>
									</svg>
								</span>
							</a>
						))}
					</div>
				</section>

				<!-- Back Link -->
				<div class="back-link">
					<a href="/blog/">← Back to all writings</a>
				</div>
			</div>
		</main>
		<Footer />
	</body>
</html>

<style>
	:root {
		--font-display: 'DM Serif Display', Georgia, serif;
		--font-body: 'IBM Plex Sans', system-ui, sans-serif;
		--color-bg: #0a0a0b;
		--color-bg-elevated: #111113;
		--color-bg-hover: #18181b;
		--color-border: #27272a;
		--color-border-subtle: #1f1f23;
		--color-text-primary: #fafafa;
		--color-text-secondary: #a1a1aa;
		--color-text-muted: #71717a;
		--color-accent: #3b82f6;
		--color-accent-subtle: rgba(59, 130, 246, 0.1);
	}

	body {
		background-color: var(--color-bg);
		color: var(--color-text-primary);
		font-family: var(--font-body);
		margin: 0;
		line-height: 1.6;
	}

	main {
		min-height: calc(100vh - 200px);
	}

	.container {
		max-width: 800px;
		margin: 0 auto;
		padding: 0 1.5rem 4rem;
	}

	/* Breadcrumb */
	.breadcrumb {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		padding: 2rem 0 1rem;
		font-size: 0.875rem;
		color: var(--color-text-muted);
	}

	.breadcrumb a {
		color: var(--color-accent);
		text-decoration: none;
		transition: color 0.2s ease;
	}

	.breadcrumb a:hover {
		color: var(--color-text-primary);
	}

	.breadcrumb .separator {
		color: var(--color-text-muted);
		opacity: 0.5;
	}

	.breadcrumb .current {
		color: var(--color-text-primary);
	}

	/* Page Header */
	.page-header {
		padding: 2rem 0 3rem;
		border-bottom: 1px solid var(--color-border-subtle);
		margin-bottom: 3rem;
	}

	.tag-badge {
		display: inline-block;
		padding: 0.5rem 1rem;
		background: var(--color-accent-subtle);
		border: 1px solid rgba(59, 130, 246, 0.3);
		border-radius: 100px;
		font-size: 0.875rem;
		color: var(--color-accent);
		margin-bottom: 1rem;
		font-weight: 500;
	}

	.page-header h1 {
		font-family: var(--font-display);
		font-size: clamp(2rem, 4vw, 3rem);
		font-weight: 400;
		margin: 0 0 0.75rem;
		color: var(--color-text-primary);
		line-height: 1.2;
	}

	.subtitle {
		font-size: 1.125rem;
		color: var(--color-text-secondary);
		margin: 0;
		line-height: 1.6;
	}

	/* Posts Section */
	.posts-section {
		margin-bottom: 3rem;
	}

	.posts-list {
		display: flex;
		flex-direction: column;
		gap: 0;
	}

	.post-item {
		display: grid;
		grid-template-columns: auto 1fr auto;
		align-items: center;
		gap: 1.5rem;
		padding: 1.5rem 0;
		border-bottom: 1px solid var(--color-border-subtle);
		text-decoration: none;
		transition: all 0.2s ease;
	}

	.post-item:hover {
		padding-left: 1rem;
		padding-right: 1rem;
		margin-left: -1rem;
		margin-right: -1rem;
		background: var(--color-bg-hover);
		border-radius: 12px;
		border-bottom-color: transparent;
	}

	.post-item:hover + .post-item {
		border-top-color: transparent;
	}

	.post-item:hover .post-arrow {
		opacity: 1;
		transform: translateX(0);
	}

	.post-item:hover h4 {
		color: var(--color-accent);
	}

	.post-number {
		font-family: 'SF Mono', 'Fira Code', monospace;
		font-size: 0.8125rem;
		color: var(--color-text-muted);
		min-width: 1.5rem;
	}

	.post-content {
		min-width: 0;
	}

	.post-content h4 {
		font-family: var(--font-body);
		font-size: 1.0625rem;
		font-weight: 500;
		margin: 0 0 0.25rem;
		color: var(--color-text-primary);
		transition: color 0.2s ease;
	}

	.post-content p {
		font-size: 0.875rem;
		color: var(--color-text-muted);
		margin: 0 0 0.375rem;
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
	}

	.post-meta {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		font-size: 0.8125rem;
		color: var(--color-text-muted);
	}

	.meta-separator {
		opacity: 0.5;
	}

	.post-arrow {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 32px;
		height: 32px;
		color: var(--color-accent);
		opacity: 0;
		transform: translateX(-8px);
		transition: all 0.2s ease;
	}

	/* Back Link */
	.back-link {
		text-align: center;
		padding: 2rem 0;
	}

	.back-link a {
		display: inline-block;
		color: var(--color-accent);
		text-decoration: none;
		font-size: 0.9375rem;
		padding: 0.75rem 1.5rem;
		border: 1px solid var(--color-border);
		border-radius: 100px;
		transition: all 0.2s ease;
	}

	.back-link a:hover {
		background: var(--color-bg-hover);
		border-color: var(--color-accent);
	}

	/* Mobile Adjustments */
	@media (max-width: 640px) {
		.post-item {
			grid-template-columns: auto 1fr;
			gap: 1rem;
		}

		.post-arrow {
			display: none;
		}

		.post-number {
			align-self: start;
			padding-top: 0.25rem;
		}
	}
</style>
