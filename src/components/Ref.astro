---
/**
 * SmartRef Component - Generic tooltip reference system
 *
 * Usage:
 *   <Ref bible="Matthew 2:13-15">Matthew 2:13-15</Ref>
 *   <Ref href="https://example.com" preview="auto">article</Ref>
 *   <Ref href="/blog/my-post">my post</Ref>
 *   <Ref term="Imago Dei" definition="...">Imago Dei</Ref>
 *   <Ref tooltip="Custom text">hover me</Ref>
 */

import { fetchVerse, formatVerseText, getShortCopyright } from '../utils/bible-api';

interface Props {
  // Content type (mutually exclusive)
  bible?: string;
  href?: string;
  term?: string;
  tooltip?: string;

  // Modifiers
  preview?: 'auto' | 'manual' | string;
  definition?: string;
  translation?: 'ESV' | 'NIV' | 'NASB';

  // Styling
  variant?: 'default' | 'subtle' | 'emphasized';
}

const {
  bible,
  href,
  term,
  tooltip,
  preview,
  definition,
  translation = 'ESV',
  variant = 'default',
} = Astro.props;

// Determine reference type
let refType: 'bible' | 'link' | 'term' | 'custom' = 'custom';
let tooltipData: any = {};

if (bible) {
  refType = 'bible';
  // Fetch verse at build time
  const verse = await fetchVerse(bible, translation);
  if (verse) {
    tooltipData = {
      reference: verse.reference,
      text: formatVerseText(verse.text, false),
      translation: verse.translation,
      copyright: getShortCopyright(verse.translation),
    };
  } else {
    console.error(`Failed to fetch Bible verse: ${bible}`);
    tooltipData = {
      reference: bible,
      text: 'Verse not found',
      translation,
      copyright: '',
    };
  }
} else if (href) {
  refType = 'link';
  tooltipData = {
    url: href,
    preview: preview || 'manual',
    isInternal: href.startsWith('/'),
  };
  // TODO: Fetch OpenGraph preview for external links
  // TODO: Fetch post metadata for internal links
} else if (term) {
  refType = 'term';
  tooltipData = {
    term,
    definition: definition || '',
  };
} else if (tooltip) {
  refType = 'custom';
  tooltipData = {
    content: tooltip,
  };
}

// Generate unique ID for this reference
const refId = `ref-${Math.random().toString(36).substr(2, 9)}`;

// Determine link href (for actual navigation)
const linkHref = href || (bible ? `https://www.esv.org/${encodeURIComponent(bible)}` : '#');
const isExternal = linkHref.startsWith('http') && !linkHref.startsWith('/');
---

<span
  class={`ref-wrapper ref-type-${refType} ref-variant-${variant}`}
  data-ref-id={refId}
  data-ref-type={refType}
  data-ref-data={JSON.stringify(tooltipData)}
>
  <a
    href={linkHref}
    class="ref-link"
    target={isExternal ? '_blank' : undefined}
    rel={isExternal ? 'noopener noreferrer' : undefined}
    role="button"
    aria-describedby={`tooltip-${refId}`}
    aria-expanded="false"
    tabindex="0"
  >
    <slot />
  </a>
</span>

<style>
  .ref-wrapper {
    position: relative;
    display: inline;
  }

  .ref-link {
    color: var(--accent);
    text-decoration: underline;
    text-decoration-style: dotted;
    text-decoration-color: rgba(59, 130, 246, 0.4);
    text-underline-offset: 3px;
    cursor: help;
    transition: all 0.2s ease;
    text-decoration-skip-ink: auto;
  }

  .ref-link:hover {
    text-decoration-style: solid;
    text-decoration-color: var(--accent);
  }

  .ref-link:focus {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
    border-radius: 2px;
  }

  /* Active state when tooltip is showing */
  .ref-wrapper.active .ref-link {
    text-decoration-style: solid;
    background: rgba(59, 130, 246, 0.1);
    border-radius: 3px;
    padding: 0 2px;
  }

  /* Variant: Subtle (less prominent) */
  .ref-variant-subtle .ref-link {
    text-decoration-color: rgba(59, 130, 246, 0.2);
    opacity: 0.9;
  }

  /* Variant: Emphasized (more prominent) */
  .ref-variant-emphasized .ref-link {
    font-weight: 500;
    text-decoration-thickness: 2px;
  }

  /* Type-specific styling */
  .ref-type-bible .ref-link {
    /* Bible references slightly different color */
    color: #3b82f6;
  }

  .ref-type-term .ref-link {
    /* Terms use accent color */
    color: var(--accent);
    font-style: italic;
  }

  .ref-type-link .ref-link {
    /* External links more traditional */
    text-decoration-style: solid;
  }

  /* Mobile: Larger touch target */
  @media (max-width: 1024px) {
    .ref-link {
      padding: 4px 2px;
      margin: -4px -2px;
    }
  }
</style>
